<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title></title>
</head>
<body>
    <div>
        <h3>Имя пользователя</h3>
        <input id="usernameInput">
        <h3>Адрес почты</h3>
        <input id="emailInput" type="email">
        <h3>Пароль</h3>
        <input id="passwordInput" type="password">
        <h3>Повтор пароля</h3>
        <input id="passwordRepeatInput" type="password">
        <br>
        <h3 id="statusLabel"></h3>
        <button id="sendButton">Получить код на почту</button>
        <h3>Код из письма</h3>
        <input id="emailcodeInput" type="number" readonly>
        <br>
        <button id="registerButton" hidden>Зарегистрироваться</button>
    </div>

    <script>
        const usernameInput = document.getElementById("usernameInput");
        const emailInput = document.getElementById("emailInput");
        const passwordInput = document.getElementById("passwordInput");
        const passwordRepeatInput = document.getElementById("passwordRepeatInput");
        const emailcodeInput = document.getElementById("emailcodeInput");
        const sendButton = document.getElementById("sendButton");
        const registerButton = document.getElementById("registerButton");
        const statusLabel = document.getElementById("statusLabel");
        const english = /^[A-Za-z0-9]*$/;

        function hasWhiteSpace(s) {
            return s.indexOf(' ') >= 0;
        }

        const validateEmail = (email) => {
            return String(email)
                .toLowerCase()
                .match(
                    /^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|.(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/
                );
        };

        function randomIntFromInterval(min, max) {
            return Math.floor(Math.random() * (max - min + 1) + min)
        }

        sendButton.onclick = (async () => {
            if (usernameInput.value.length > 30 || usernameInput.value.length < 4) {
                statusLabel.innerHTML = "Имя пользователя должно содержать от 4 до 30 символов";
                setTimeout(() => statusLabel.innerHTML = "", 3000);
            }

            else if (hasWhiteSpace(usernameInput.value)) {
                statusLabel.innerHTML = "Имя пользователя не должно содержать пробелов";
                setTimeout(() => statusLabel.innerHTML = "", 3000);
            }

            else if (!english.test(usernameInput.value)) {
                statusLabel.innerHTML = "В названии только английские символы";
                setTimeout(() => statusLabel.innerHTML = "", 3000);
            }

            else if (!validateEmail(emailInput.value)) {
                statusLabel.innerHTML = "Некорректная почта";
                setTimeout(() => statusLabel.innerHTML = "", 3000);
            }

            else if (passwordInput.value.length < 6 || passwordInput.value.length > 255) {
                statusLabel.innerHTML = "Длина пароля должна быть от 6 до 255 символов";
                setTimeout(() => statusLabel.innerHTML = "", 3000);
            }

            else if (passwordRepeatInput.value !== passwordInput.value) {
                statusLabel.innerHTML = "Пароли должны совпадать";
                setTimeout(() => statusLabel.innerHTML = "", 3000);
            }

            else {
                const email = emailInput.value;
                const code = randomIntFromInterval(10000, 99999).toString();
                console.log(code);
                const username = usernameInput.value.toLowerCase();
                await fetch("sendemail", {
                    method: "POST",
                    body: JSON.stringify({
                        email, code, username
                    }),
                    headers: {
                        "Content-Type": "application/json"
                    }
                }).then((response) => {
                    if (!response.ok) {
                        statusLabel.innerHTML = "Пользователь с таким именем уже существует";
                        setTimeout(() => statusLabel.innerHTML = "", 3000);
                    }

                    else {
                        usernameInput.setAttribute("readonly", true);
                        emailInput.setAttribute("readonly", true);
                        const password = passwordInput.value;
                        passwordInput.setAttribute("readonly", true);
                        passwordRepeatInput.setAttribute("readonly", true);
                        sendButton.hidden = true;
                        emailcodeInput.removeAttribute("readonly");
                        registerButton.hidden = false;
                        registerButton.onclick = (async () => {
                            if (emailcodeInput.value != code) {
                                statusLabel.innerHTML = "Неверный код";
                                setTimeout(() => statusLabel.innerHTML = "", 3000);
                            }

                            else {
                                await fetch("register", {
                                    method: "POST",
                                    body: JSON.stringify({
                                        username,
                                        email,
                                        password
                                    }),
                                    headers: {
                                        "Content-Type": "application/json"
                                    }
                                });

                                document.location.href = "/";
                            }
                        });
                    }
                });
            }
        });

    </script>
</body>
</html>